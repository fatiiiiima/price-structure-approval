<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Price Process</title>
    <!-- Link Bootstrap CSS -->
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .display-values {
        display: flex;
        flex-direction: row;
        gap: 2px;
      }
    </style>
    <script>
      let currency = "";

      function formatNumber(value) {
        return value.toLocaleString(); // Formats the number based on the user's locale
      }

      async function fetchSKUInfo(event) {
        event.preventDefault(); // Prevent form submission

        const skuNumber = document.getElementById("skuSelect").value;

        const country = document.getElementById("countrySelect").value;

        // Send request to backend
        const response = await fetch("/get_sku_info", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ sku_number: skuNumber, country: country }),
        });

        const data = await response.json();

        if (response.ok) {
          displaySKUInfo(data);
        } else if (data.missing_sku) {
          if (
            confirm(
              `The SKU ${skuNumber} for ${country} does not exist. Would you like to send an email to the admin?`
            )
          ) {
            await sendMissingSKUEmail(skuNumber, country);
          } else {
            alert(data.error);
          }
        }
      }

      function displaySKUInfo(data) {
        const displaySection = document.getElementById("skuInfo");
        if (response.ok) {
          currency = data.currency;
          

          displaySection.innerHTML = `
          <h3>SKU Details:</h3>
          <div class="display-values">
          <p><strong>Description:</strong></p>
          <p id="description"> ${data.description}</p>
          </div>          <p><strong>Brand:</strong> ${data.brand}</p>
          <p><strong>Sector:</strong> ${data.sector}</p>
          <p><strong>Flavor:</strong> ${data.flavor}</p>
          <p><strong>Format:</strong> ${data.format}</p>
          <p><strong>Packing:</strong> ${data.packing}</p>
          <p><strong>Project:</strong> ${data.project}</p>
          <p><strong>Type:</strong> ${data.type}</p>
         <div class="display-values">
          <p><strong>VAT %:</strong></p>
          <p id="vat"> ${data.vat.toFixed(2)}%</p>
          </div>
          <div class="display-values">
          <p><strong>RM %:</strong></p>
          <p id="rm"> ${data.rm.toFixed(2)}%</p>
          </div>
          
          <div class="display-values">
          <p><strong>WSM %:</strong></p>
          <p id="wsm"> ${data.wsm.toFixed(2)}%</p>
          </div>

          <div class="display-values">
          <p><strong>DM %:</strong></p>
          <p id="dm"> ${data.dm.toFixed(2)}%</p>
          </div>
          <div class="display-values">
          <p><strong>Duty %:</strong></p>
          <p id="duty"> ${data.duty.toFixed(2)}%</p>
          </div>
          <div class="display-values">
          <p><strong>Clearing Charges %:</strong></p>
          <p id="cc"> ${data.clearingcharges.toFixed(2)}%</p>
          </div>

          <div class="display-values">
          <p><strong>Bad and Damages %:</strong></p>
          <p id="bd"> ${data.bd.toFixed(2)}%</p>
          </div>
          <div class="display-values">
          <p><strong>CPP %:</strong></p>
          <p id="cpp"> ${data.cpp.toFixed(2)}%</p>
          </div>

          <div class="display-values">
          <p><strong>RSP excluding VAT (per piece):</strong></p>
          <p id="rsp"> ${data.rsp}</p>
          </div>

          <div class="display-values">
          <p><strong>RSP (per case):</strong></p>
          <p id="rsppercase"> ${data.rsppercase}</p>
          </div>
          <div class="display-values">
          <p><strong>BPTT (per case):</strong></p>
          <p id="bptt"> ${data.bptt}</p>
          </div>
          <div class="display-values">
          <p><strong>CIF (per case):</strong></p>
          <p id="cif"> ${data.cif}</p>
          </div>
        
          <div class = "display-values">
          <p><strong>Total cogs per case (in ${data.currency}): </strong></p>
          <p id="cogs_local_case"> ${data.cogs_per_case}</p>
          </div>
          <div class = "display-values">
          <p><strong>Pieces per case:</strong></p>
          <p id="pcs"> ${data.pcs_per_case}</p>
          </div>
          
          <div class = "display-values">
          <p><strong>Case per ton:</strong></p>
          <p id="case_per_ton"> ${data.case_per_ton}</p>
          </div>
          <div class = "display-values">
          <p><strong>Total cogs per ton (in USD):</strong></p>
          <p id="cogs_usd"> ${formatNumber(data.total_cogs_usd)}</p>
          </div>
          <div class = "display-values">
          <p><strong>Total cogs per ton (in ${data.currency}):</strong></p>
          <p id="cogs_local"> ${formatNumber(data.total_cogs_local)}</p>
          </div>
          <div class = "display-values">
          <p><strong>TTS%:</strong></p>
          <p id="tts"> ${data.tts}</p>
          </div>
          <div class="form-group">
           <label for="newRSP">New RSP (in ${data.currency}) (per piece)</label>
             <input 
              type="text" 
              class="form-control" 
              id="newRSP" 
              placeholder="New RSP">
            <label for="newTTS">New TTS (in %)</label>
             <input 
              type="text" 
              class="form-control" 
              id="newTTS" 
              placeholder="New TTS (in %)"
              oninput="validateTTS()">
            <p id="errorTTS" style="color: red; display: none;">TTS cannot exceed 100%</p>
            <button type="submit" class="btn btn-primary"onclick="calculate_values()">Calculate</button>
          </div> 
        `;
        } else {
          displaySection.innerHTML = `<p style="color: red;">${data.error}</p>`;
        }
      }

      async function sendMissingSKUEmail(skuNumber, country) {
        const response = await fetch("/send_missing_sku_email", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ sku_number: skuNumber, country: country }),
        });

        const data = await response.json();
        if (response.ok) {
          alert(data.message);
        } else {
          alert("Failed to send the email. Please try again later.");
        }
      }

      function validateTTS() {
        const ttsInput = document.getElementById("newTTS");
        const errorTTS = document.getElementById("errorTTS");
        const calculateBtn = document.getElementById("calculateBtn");

        const ttsValue = parseFloat(ttsInput.value);

        if (ttsValue > 100) {
          errorTTS.style.display = "block"; // Show error message
          calculateBtn.disabled = true; // Disable the button
        } else {
          errorTTS.style.display = "none"; // Hide error message
          calculateBtn.disabled = false; // Enable the button
        }
      }

      function removePercentageSign(value) {
        if (typeof value === "string") {
          // Remove the '%' sign and trim any whitespace
          const numericValue = value.replace("%", "").trim();

          // Convert to a decimal if the result is a valid number
          const decimalValue = parseFloat(numericValue);
          return isNaN(decimalValue) ? 0 : decimalValue / 100;
        }
        return 0; // Default to 0 for non-string or invalid inputs
      }

      async function calculate_values() {
        const newRSP = document.getElementById("newRSP").value;
        

        const newTTS = document.getElementById("newTTS").value;

        const cogs_local_per_case =
          document.getElementById("cogs_local_case").innerText;
        const pcs = document.getElementById("pcs").innerText;
        const vat = document.getElementById("vat").innerText;
        const newVat = removePercentageSign(vat);
        const rm = document.getElementById("rm").innerText;
        const newRM = removePercentageSign(rm);
        const wsm = document.getElementById("wsm").innerText;
        const newWSM = removePercentageSign(wsm);
        const dm = document.getElementById("dm").innerText;
        const newDM = removePercentageSign(dm);
        const duty = document.getElementById("duty").innerText;
        const newDuty = removePercentageSign(duty);
        const cc = document.getElementById("cc").innerText;
        const newCC = removePercentageSign(cc);
        const bd = document.getElementById("bd").innerText;
        const newBD = removePercentageSign(bd);
        const cpp = document.getElementById("cpp").innerText;
        const newCPP = removePercentageSign(cpp);

        const response = await fetch("/calculate_results", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            newRSP,
            newVat,
            newRM,
            newWSM,
            newDM,
            newDuty,
            newCC,
            newBD,
            newCPP,
            pcs,
            newTTS,
            cogs_local_per_case,
          }),
        });

        const data = await response.json();

        if (response.ok) {
          // Display calculated values
          document.getElementById("skuInfo").innerHTML += `
      <h3>Calculated Values:</h3>
   <div class="display-values">
     <p><strong>RSP (per piece) (in ${currency}):</strong></p>
          <p id="new_rsp"> ${data.newRSP.toFixed(2)}</p>
    </div>

       <div class="display-values">
     <p><strong>New RSP (per case) (in ${currency}):</strong></p>
          <p id="new_rsp_per_case"> ${data.newRSPPerCase}</p>
    </div>

  <div class="display-values">
    <p><strong>New BPTT (per case) (in ${currency}):</strong></p>
        <p id="new_bptt"> ${data.newBPTT.toFixed(2)}</p>
  </div>
      
  <div class="display-values">
    <p><strong>New CIF (per case) (in ${currency}):</strong></p>
      <p id="new_cif"> ${data.newCIF.toFixed(2)}</p>
  </div>


 

  <div class="display-values">
    <p><strong>GSV (per case) (in ${currency}):</strong></p>
       <p id="gsv"> ${data.newGSV.toFixed(2)}</p>
  </div>


  <div class="display-values">
    <p><strong>Cogs per case:</strong></p>
        <p id="new_cogs"> ${data.cogs.toFixed(2)}</p>
  </div>

  <div class="display-values">
    <p><strong>TTS%:</strong></p>
      <p id="new_tts_percentage"> ${data.tts_percentage.toFixed(2)}</p>
      <p>%</p>
  </div>
  
  <div class="display-values">
    <p><strong>TTS (per case) (in ${currency}):</strong></p>
      <p id="new_tts"> ${data.tts.toFixed(2)}</p>
  </div>
        
  <div class="display-values">
    <p><strong>TO (per case) (in ${currency}):</strong></p>
      <p id="to"> ${data.to.toFixed(2)}</p>
  </div>

  <div class="display-values">
    <p><strong>GP (per case) (in ${currency}):</strong></p>
     <p id="gp"> ${data.gp.toFixed(2)}</p>
  </div>

        

  <div class="display-values">
    <p><strong>Gross Margin %:</strong></p>
      <p id="gm"> ${data.gm.toFixed(2)}</p>
      <p>%</p>
  </div>



      <button type="submit" class="btn btn-primary" onClick="submitRequest()">Submit for Approval</button>
    `;
        } else {
          console.error("Error in calculation:", data.error);
        }
      }

      async function submitRequest() {
        // Collect data from calculated values or other inputs
        const skuCode = document.getElementById("skuSelect").value;
        const country = document.getElementById("countrySelect").value;
        const newBPTT = document.getElementById("new_bptt").innerText;
        const newCIF = document.getElementById("new_cif").innerText;
        const newRSP = document.getElementById("new_rsp").innerText;
        const newRSPPerCase =
          document.getElementById("new_rsp_per_case").innerText;
        const newGSV = document.getElementById("gsv").innerText;
        const tts = document.getElementById("new_tts_percentage").innerText;
        const to = document.getElementById("to").innerText;
        const gp = document.getElementById("gp").innerText;
        const gm = document.getElementById("gm").innerText;
        const cogs_new = document.getElementById("new_cogs").innerText;
        const sku_description =
          document.getElementById("description").innerText;

        const newTTS = document.getElementById("newTTS").value;

        const cogs_local_per_case =
          document.getElementById("cogs_local_case").innerText;
        const pcs = document.getElementById("pcs").innerText;
        const vat = document.getElementById("vat").innerText;
        const newVat = removePercentageSign(vat);
        const rm = document.getElementById("rm").innerText;
        const newRM = removePercentageSign(rm);
        const wsm = document.getElementById("wsm").innerText;
        const newWSM = removePercentageSign(wsm);
        const dm = document.getElementById("dm").innerText;
        const newDM = removePercentageSign(dm);
        const duty = document.getElementById("duty").innerText;
        const newDuty = removePercentageSign(duty);
        const cc = document.getElementById("cc").innerText;
        const newCC = removePercentageSign(cc);
        const bd = document.getElementById("bd").innerText;
        const newBD = removePercentageSign(bd);
        const cpp = document.getElementById("cpp").innerText;
        const newCPP = removePercentageSign(cpp);

      
        try {
          const response = await fetch("/submit_request", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              sku_code: skuCode,
              country: country,
              bptt: newBPTT,
              cif: newCIF,
              new_rsp: newRSP,
              gsv: newGSV,
              new_tts: tts,
              to: to,
              gp: gp,
              gm: gm,
              cogs: cogs_new,
              sku_description: sku_description,
              newVat,
              newRM,
              newWSM,
              newDM,
              newDuty,
              newCC,
              newBD,
              newCPP,
              pcs,
              new_rsp_per_case: newRSPPerCase,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            alert("Request submitted successfully!");
          } else {
            alert(`Error: ${data.error}`);
          }
        } catch (error) {
          console.error("Error submitting request:", error);
          alert("Failed to submit request. Please try again.");
        }
      }
    </script>
  </head>
  <body>
    <div class="container mt-5">
      <h1>Price Structure</h1>
      <form onsubmit="fetchSKUInfo(event)">
        <div class="form-group">
          <label for="descriptionSelect">SKU Description</label>
          <select
            class="form-control"
            id="descriptionSelect"
            onchange="fetchSKUsByDescription()"
          >
            <option value="">Loading Descriptions...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="skuSelect">SKU Number</label>
          <select class="form-control" id="skuSelect">
            <option value="">Select Description First</option>
          </select>
        </div>
        <div class="form-group">
          <label for="countrySelect">Country</label>
          <select class="form-control" id="countrySelect">
            <option value="KSA">KSA</option>
            <option value="UAE">UAE</option>
            <option value="Kuwait">Kuwait</option>
            <option value="Qatar">Qatar</option>
            <option value="Oman">Oman</option>
            <option value="Bahrain">Bahrain</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
      <div id="skuInfo" class="mt-4">
        <!-- Dynamic SKU info will appear here -->
      </div>
      <div>
        <a href="/logout">Logout</a>
      </div>
      <div>
        <a href="{{ url_for('view_requests') }}">View your Requests</a>
      </div>
    </div>
    <script>
      // Function to populate the SKU dropdown
      // async function loadSKUs() {
      //   const skuSelect = document.getElementById("skuSelect");

      //   try {
      //     const response = await fetch("/get_skus"); // Call the backend route
      //     const data = await response.json();

      //     if (response.ok) {
      //       // Clear existing options
      //       skuSelect.innerHTML = '<option value="">Select SKU</option>';

      //       // Add options dynamically
      //       data.skus.forEach((sku) => {
      //         const option = document.createElement("option");
      //         option.value = sku;
      //         option.textContent = sku;
      //         skuSelect.appendChild(option);
      //       });
      //     } else {
      //       console.error("Failed to fetch SKUs:", data.error);
      //     }
      //   } catch (error) {
      //     console.error("Error fetching SKUs:", error);
      //   }
      // }

      // // Load SKUs when the page loads
      // window.onload = loadSKUs;

      // Function to populate the SKU Description dropdown
      async function loadDescriptions() {
        const descriptionSelect = document.getElementById("descriptionSelect");

        try {
          const response = await fetch("/get_sku_descriptions");
          const data = await response.json();

          if (response.ok) {
            descriptionSelect.innerHTML =
              '<option value="">Select Description</option>';

            data.descriptions.forEach((description) => {
              const option = document.createElement("option");
              option.value = description;
              option.textContent = description;
              descriptionSelect.appendChild(option);
            });
          } else {
            console.error("Failed to fetch descriptions:", data.error);
          }
        } catch (error) {
          console.error("Error fetching descriptions:", error);
        }
      }

      // Function to fetch SKUs by selected description
      async function fetchSKUsByDescription() {
        const descriptionSelect = document.getElementById("descriptionSelect");
        const skuSelect = document.getElementById("skuSelect");
        const selectedDescription = descriptionSelect.value;

        if (!selectedDescription) {
          skuSelect.innerHTML =
            '<option value="">Select Description First</option>';
          return;
        }

        try {
          const response = await fetch("/get_skus_by_description", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ description: selectedDescription }),
          });
          const data = await response.json();

          if (response.ok) {
            skuSelect.innerHTML = '<option value="">Select SKU</option>';

            data.skus.forEach((sku) => {
              const option = document.createElement("option");
              option.value = sku;
              option.textContent = sku;
              skuSelect.appendChild(option);
            });
          } else {
            console.error("Failed to fetch SKUs:", data.error);
          }
        } catch (error) {
          console.error("Error fetching SKUs:", error);
        }
      }

      // Load descriptions when the page loads
      window.onload = loadDescriptions;
    </script>
  </body>
</html>
